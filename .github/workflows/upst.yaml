name: Generate JWT and RSA key pair
on: workflow_dispatch   # 手動実行。定期実行なら cron を追加

permissions:
  id-token: write   # OIDC JWT を取得するため
  contents: read

jobs:
  call-oci:
    runs-on: ubuntu-latest

    steps:
      - name: Get OIDC JWT (audience = OCI)
        id: oidc
        uses: actions/github-script@v7
        with:
          script: |
            const t = await core.getIDToken('https://oraclecloud.com/');
            core.setOutput('jwt', t);

      # 🔑 1) 鍵ペアを生成
      - name: Gen RSA key
        run: |
          openssl genrsa -out key.pem 2048
          openssl rsa -pubout -in key.pem | tr -d '\n' > pub.txt

      # 🔄 2) JWT ➜ UPST 交換（公開鍵だけ送る）
      - name: Exchange for UPST
        run: |
          UPST=$(curl -s https://identity.${REGION}.oraclecloud.com/oauth2/v1/token \
            -d "grant_type=token-exchange" \
            -d "subject_token=${{ steps.oidc.outputs.jwt }}" \
            -d "subject_token_type=urn:ietf:params:oauth:token-type:jwt" \
            -d "public_key=$(cat pub.txt)" | jq -r .token)
          echo "UPST=$UPST" >> $GITHUB_ENV
      - name: Upload keys & JWT
        uses: actions/upload-artifact@v4
        with:
          name: jwt-and-keys
          path: |
            keys/public.pem
            keys/private.pem
            echo "${{ steps.jwt.outputs.token }}" > jwt.txt
            jwt.txt

