name: upload-github-jwt
on: workflow_dispatch          # 手動実行

permissions:
  id-token: write              # OIDC JWT を取得するのに必須
  contents: read               # actions/checkout を使う場合など

jobs:
  fetch-and-upload:
    runs-on: ubuntu-latest
    steps:
      # ① 必要ならリポジトリをチェックアウト（省略可）
      - uses: actions/checkout@v4

      # ② GitHub の OIDC プロバイダーから JWT を取得
      - name: Get OIDC token
        id: oidc
        uses: actions/github-script@v8
        with:
          script: |
            // audience（aud）を固定したい場合は書き換えてください
            const aud = 'https://example.com';
            const token = await core.getIDToken(aud);
            require('fs').writeFileSync('github_oidc_jwt.txt', token);
            core.info(`Saved OIDC token to github_oidc_jwt.txt`);

      # ③ JWT を Artifact としてアップロード
      - name: Upload JWT as artifact
        uses: actions/upload-artifact@v4
        with:
          name: github-oidc-jwt          # Artifact 名
          path: github_oidc_jwt.txt      # アップロードするファイル
          retention-days: 1              # 保存期間（1〜90 日で指定）
