name: get-oidc-jwt
on: workflow_dispatch

permissions:
  id-token: write        # JWT を要求するのに必須
  contents: read         # 例: actions/checkout を使う場合

jobs:
  issue-jwt:
    runs-on: ubuntu-latest
    steps:
      # (任意) リポジトリをチェックアウト
      - uses: actions/checkout@v4

      # ① actions/toolkit の getIDToken() で取得する例
      - name: Get OIDC token (ToolKit)
        id: get_token_toolkit
        uses: actions/github-script@v7
        with:
          script: |
            // audience はクラウド側で検証したい値
            const aud = 'https://example.com';
            const idToken = await core.getIDToken(aud);  // audience 指定も可能:contentReference[oaicite:1]{index=1}
            core.setOutput('jwt', idToken);

      # ② 環境変数 + curl だけで取得する例
      - name: Get OIDC token (curl)
        id: get_token_curl
        run: |
          aud='https://example.com'
          resp=$(curl -sL \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${aud}" \
            -H "Authorization: Bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}")
          echo "jwt=$(echo "$resp" | jq -r '.value')" >> "$GITHUB_OUTPUT"

      # 確認用にマスクして出力
      - name: Echo first 3 JWT claims (debug)
        run: |
          # `jq -R 'split(".") | .[0:3][]'` でヘッダー／ペイロード／署名部分を分割
          echo "${{ steps.get_token_curl.outputs.jwt }}" | \
            cut -d'.' -f1,2 | tr '.' '\n' | base64 -d | jq .
