name: Get GitHub Actions JWT
on:
  workflow_dispatch:
    inputs:
      audience:
        description: 'JWT audience'
        required: false
        default: 'oci'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Restore private key
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_UPST_PRIVATE_KEY_PEM }}" > ~/.oci/oci_upst_key.pem
          chmod 600 ~/.oci/oci_upst_key.pem

      - name: Get OIDC JWT for this job
        id: oidc
        uses: actions/github-script@v7
        with:
          script: |
            const token = await core.getIDToken('https://oracle-cloud.com/');
            core.setOutput('jwt', token);

      - name: Exchange JWT â†’ UPST
        run: |
          PUB=$(awk 'NF {sub(/\r/,""); printf "%s\\n",$0}' ~/.oci/oci_upst_key.pem | \
                openssl rsa -pubout 2>/dev/null | tr -d '\n')
          curl -s https://identity.${{ env.OCI_REGION }}.oraclecloud.com/oauth2/v1/token \
            -d "grant_type=token-exchange&subject_token=${{ steps.oidc.outputs.jwt }}&subject_token_type=urn:ietf:params:oauth:token-type:jwt&public_key=$PUB" > upst.json
          echo "UPST=$(jq -r .token upst.json)" >> $GITHUB_ENV

      - name: Call OCI API using UPST
        env:
          PRIVATE_KEY: ~/.oci/oci_upst_key.pem
        run: |
          oci raw-request --http-method GET \
            --target-uri https://iaas.${{ env.OCI_REGION }}.oraclecloud.com/20160918/regions \
            --auth security_token \
            --security-token-env-var UPST \
            --key-file $PRIVATE_KEY
